<!DOCTYPE html>
<html>
<head>
<title>Echoblock</title>
<meta charset="utf-8">
<style>
div#d3-stage {
    overflow: scroll;
}
rect.echo-rect {
    stroke: white;
    stroke-width: 2px;
}
</style>
</head>
<body>
<script type="text/javascript" src="remix.js"></script>
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>  
<script>
// Adapted from remix.js example code by Paul Lamere + tkell (Thor) + Echonest
// https://github.com/echonest/remix.js/blob/master/examples
// Song is public domain from Archive.org
// https://archive.org/details/BeethovensSymphonyNo.9_51

// First-beat extraction and assembly
// You will need to supply your Echo Nest API key, the trackID, and a URL to the track.
// The supplied track can be found in the audio subdirectory.
var echonestAPIKey;
var trackID = 'TRCYWPQ139279B3308';
var trackURL = 'BeethovensSymphonyNo9scherzo.mp3'
var remixer;
var player;
var track;
var remixed;

function init() {
    echonestAPIKey = localStorage.getItem('echonestAPIKey') || '';
    $('#echonestAPIKeyForm').val(echonestAPIKey);
}

function main() {
    echonestAPIKey = $('#echonestAPIKeyForm').val();
    localStorage.setItem('echonestAPIKey', echonestAPIKey);
    var contextFunction = window.AudioContext || window.webkitAudioContext;
    if (contextFunction === undefined) {
        $("#info").text("Sorry, this app needs advanced web audio. Your browser doesn't"
            + " support it. Try the latest version of Chrome?");
    } else {
        var context = new contextFunction();
        remixer = createJRemixer(context, $, echonestAPIKey);
        player = remixer.getPlayer();
        $("#info").text("Loading analysis data...");
        remixer.remixTrackById(trackID, trackURL, function(t, percent) {
            track = t;
            $("#info").text(percent + "% of the track loaded");
            if (percent == 100) {
                $("#info").text(percent + "% of the track loaded, remixing...");
            }
            if (track.status == 'ok') {
                remixed = [];
                // Do the remixing here!
                for (var i=0; i < track.analysis.beats.length; i++) {
                    if (i % 4 === 0) {
                        remixed.push(track.analysis.beats[i]);
                    }
                }
                $("#info").text("Remix complete!");
                var index = 0;
                DrawRects(track.analysis.segments, 'gray', index++);
                console.log(index);
                DrawRects(track.analysis.tatums, 'blue', index++);
                console.log(index);
                DrawRects(track.analysis.beats, 'orange', index++);
                console.log(index);
                DrawRects(track.analysis.bars, 'green', index++);
                console.log(index);
                DrawRects(track.analysis.sections, 'red', index++);
                console.log(index);
            }
        });
    }
}

function DrawRects(echoData, fillColor, level) {
    var widthScale = 100;
    var duration = track.audio_summary.duration;
    var svgWidth = duration * widthScale;
    var svgHeight = 100;
    var gOrigin = d3.select('div#d3-stage').select('svg')
        .attr('width', svgWidth)
        .attr('height', svgHeight)
        .append('g')
            .attr('transform', 'translate(0,'+String(level*15)+')');
    gOrigin.selectAll('.echo-rect').data(echoData).enter()
        .append('rect')
            .classed('echo-rect', true)
            .attr('x', function(d) { return d.start * widthScale; })
            .attr('y', 0)
            .attr('width', function(d) {
                d.originalWidth = d.duration * widthScale;
                return d.duration * widthScale;
            })
            .attr('height', 10)
            .style('fill', fillColor)
            .on('click', function(d) {
                player.stop();
                var currentlyPlaying = d.playing;
                d3.select('div#d3-stage').selectAll('rect.echo-rect').interrupt();
                d3.select('div#d3-stage').selectAll('rect.echo-rect')
                    .style('opacity', 1)
                    .attr('width', function(d) { return d.originalWidth; })
                    .each(function(d) { d.playing = false; });
                if (!currentlyPlaying) {
                    player.play(0, d);
                    d3.select(this)
                        .style('opacity', 0)
                        .attr('width', 0)
                        .transition().ease('linear').duration(function(d) { return 1000*d.duration; })
                            .style('opacity', 1)
                            .attr('width', function(d) { return d.originalWidth; })
                            .each('end', function(d) { d.playing = false; });
                }
            });
}

window.onload = init;

</script>
Enter your Echonest API key: <input type='form' id='echonestAPIKeyForm'></input>
<br><br>
<button onClick='main()'>Initialize</button>
<br><br>
<div id='info'> </div>
<button onClick="player.play(0, remixed);">Play!</button>
<button onClick="player.stop()">Stop!</button>
<br><br>
<div id="d3-stage">
<svg></svg>
</div>
</body>

</html>
